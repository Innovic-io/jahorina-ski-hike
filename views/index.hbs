{{> header}}
<style>
  #map {
    height:100%;
  }
</style>
<script>
  const placeData = [
    {{#each placesData}}
      {{{json this}}},
    {{/each}}
  ];

  const placeTypesData = {
    {{#each city.categories}}
      {{@key}}: '{{this}}',
    {{/each}}
  };

  function initMap() {
    const cityLatLng = {lat: 43.8118946, lng: 18.5711013};

    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 15,
      center: cityLatLng
    });

    var image = {
      url: placeData[0].icon,
      scaledSize: new google.maps.Size(32, 32),
    };

    for (var i = 0; i < placeData.length; i++) {
      var marker = new google.maps.Marker({
        position: {
          lat: placeData[i].geometry.location.lat,
          lng: placeData[i].geometry.location.lng,
        },
        map: map,
        icon: image,
        animation: google.maps.Animation.DROP
      });

      var photoReference = `https://maps.googleapis.com/maps/api/place/photo?key=AIzaSyDol6fmDmviEYTR-yIL6On7AiIcyelmsW8&maxwidth=300&maxheight=300`;

      var infowindow = new google.maps.InfoWindow({
        name: placeData[i].name,
        image: (placeData[i].photos) ? `${photoReference}&photoreference=${placeData[i].photos[0].photo_reference}` : placeData[i].icon,
        address: placeData[i].vicinity,
        is_open: (placeData[i].hasOwnProperty('opening_hours')) ? placeData[i].opening_hours.open_now : true,
        rating: Math.round(placeData[i].rating),
        types: placeData[i].types
      });

      marker.infowindow = infowindow;

      marker.addListener('click', function() {
        // this.infowindow.open(map, this);
        $('.ui.tiny.modal').modal('show');
        $('.modal-title').text(`ViÅ¡e detalja o mjestu ${this.infowindow.name}`);
        $('#modal-image').attr('src', this.infowindow.image);
        $('.modal-subtitle').text(this.infowindow.name);
        $('.description-address').text(this.infowindow.address);

        if (this.infowindow.is_open) {
          $('.description-is-open').addClass('ui green label');
          $('.description-is-open').text('Otvoreno');
        }
        else {
          $('.description-is-open').addClass('ui red label');
          $('.description-is-open').text('Zatvoreno');
        }

        $('.description-rating').attr('data-rating', this.infowindow.rating);

;       $.each(this.infowindow.types , function(index, value) {
          if (placeTypesData[value]) {
            $('.description-types').append(`<a class="ui blue label">${placeTypesData[value]}</a>`);
          }
        });
      });
    }
  }
</script>
<div id="map" class="ui embed"></div>
<div class="ui tiny modal">
  <i class="close icon"></i>
  <div class="modal-title header"></div>
  <div class="image content">
    <div class="ui medium image">
      <img id="modal-image" src="">
    </div>
    <div class="description">
      <div class="modal-subtitle ui header"></div>
      <div class="ui list">
        <div class="item">
          <i class="marker icon"></i>
          <div class="description-address content"></div>
        </div>
        <div class="item">
          <div class="content"><a class="description-is-open"></a></div>
        </div>
        <div class="item">
          <div class="content">
            <div class="description-rating ui star rating" data-max-rating="5"></div>
          </div>
        </div>
        <div class="item">
          <div class="description-types content">

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDol6fmDmviEYTR-yIL6On7AiIcyelmsW8&libraries=places&callback=initMap" async defer></script>
